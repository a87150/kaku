{% extends 'base.html' %}

{% block main %}
    <main class="col-md-8 mb-1">
        <div class="card card-block">
            <div class="media">
                <div class="media-left">
                    <img class="media-object" src="{{ user.mugshot_thumbnail.url }}" alt=""
                         style="width: 73px;"></img>
                </div>
                <div class="media-body">
                    <h3 class="media-heading">{{ user.nickname }}</h3>
                    <p>{{ user.signature }}</p>
                    <div>django forum demo 第 {{ user.pk }} 号会员，加入于 {{ user.date_joined }}</div>
                </div>
            </div>
        </div>
    <div class="production">
        <ul class="list-group mb-1">
            <li class="list-group-item font-weight-bold">
                {{ user.nickname }} 的作品
            </li>
            {% for article in article_list %}
            <li class="list-group-item">
                <a class="nav-item" href="{{ article.get_absolute_url }}"> {{ article }} </a>
            </li>
            {% empty %}
            <li class="list-group-item">该用户下面没有</li>
            {% endfor %}
            {% if not article_list.count < 10 %}
            <li class="list-group-item small"><a href="{% url 'users:articles' user.username %}"
                class="text-muted">{{ user.nickname }}更多作品>></a></li>
            {% endif %}
        </ul>
    </div>
    {% if request.user.is_authenticated %}
    <div class="affairs">
        <ul class="list-group mb-2">
            <li class="list-group-item font-weight-bold">用户最新动态
            </li>

            {% for act in action_list %}
                <li class="list-group-item">
                    {{ act }}
                </li>
            {% empty %}
                <li class="list-group-item">该用户下没有动态</li>
            {% endfor %}
            {% if not action_list.count < 20 %}
                <li class="list-group-item small"><a href="{% url 'users:actions' user.username %}"
                class="text-muted">{{ user.nickname }}的全部动态>></a></li>
            {% endif %}
        </ul>
    </div>
        {% else %}
        <div class="card card-block">
            需要登录才能查看用户动态
        </div>
        {% endif %}
    </main>
{% endblock main %}

{% block script %}
    <script>
        function follow(e) {
            var $this = $(this);
            var $ctypeId = $this.attr('data-contenttype-id');
            var $objectId = $this.attr('data-object-id');
            var $url = '/follows/follow_all/' + $ctypeId + '/' + $objectId + '/follow/';
            $.post(
                $url,
                {
                    content_type_id: $ctypeId,
                    object_id: $objectId,
                    ftype: 'follow'
                },
                function (data, status) {
                    $this.find('a').first().html('<i class="fa fa-check" aria-hidden="true"></i> 已关注');
                    var $followNumber = $this.next().first().find('.follow-number').first();
                    $followNumber.text(parseInt($followNumber.text()) + 1);
                    $this.off('click');
                    $this.on('click', unfollow)
                }
            );
            e.preventDefault();
        }

        function unfollow(e) {
            var $this = $(this);
            var $ctypeId = $this.attr('data-contenttype-id');
            var $objectId = $this.attr('data-object-id');
            var $url = '/follows/unfollow_all/' + $ctypeId + '/' + $objectId + '/follow/';
            $.post(
                $url,
                {
                    content_type_id: $ctypeId,
                    object_id: $objectId,
                    ftype: 'follow'
                },
                function (data, status) {
                    $this.find('a').first().html('<i class="fa fa-plus" aria-hidden="true"></i> 关注');
                    var $followNumber = $this.next().first().find('.follow-number').first();
                    $followNumber.text(parseInt($followNumber.text()) - 1);
                    $this.off('click');
                    $this.on('click', follow)
                }
            );
            e.preventDefault();
        }

        $('.follow-btn').on('click', follow);
        $('.unfollow-btn').on('click', unfollow);
    </script>
{% endblock script %}